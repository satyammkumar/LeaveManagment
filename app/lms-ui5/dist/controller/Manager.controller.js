sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/format/DateFormat","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,s,n,r,i){"use strict";return e.extend("lmsui5.controller.Manager",{onInit:function(){const e=new t({kpi:{pending:0,approvedToday:0,rejectedToday:0},counts:{leaveRequests:""},leaveTypes:[],leaveTypeDescByCode:{},leaveTypeFullDescByCode:{},rejectData:{employeeName:"",leaveType:"",comments:"",commentLength:0,requestId:"",isBulk:false,bulkRequests:[]},busy:true,dataLoaded:false,useActionFeed:false,lastActionEmployeeID:""});this.getView().setModel(e,"view");this.byId("selStatus")?.setSelectedKey("Pending");const o=this.getView().getModel();if(o&&o.setSizeLimit){o.setSizeLimit(1e4)}this._loadLeaveTypes()},_loadLeaveTypes:function(){const e=this.getView().getModel();const t=this.getView().getModel("view");if(!e||!e.read){console.error("OData model not available");t.setProperty("/busy",false);return}e.read("/LeaveTypes",{urlParameters:{$select:"code,description"},success:e=>{const o=e?.results||e?.value||[];const s={};const n={};o.forEach(e=>{const t=String(e.code).trim().toUpperCase();const o=e.description||"";s[t]=o||t;n[t]=o?`${t} - ${o}`:t});t.setProperty("/leaveTypes",o);t.setProperty("/leaveTypeDescByCode",s);t.setProperty("/leaveTypeFullDescByCode",n);t.setProperty("/dataLoaded",true);t.setProperty("/busy",false);this._refreshTableBindings()},error:e=>{console.error("Error loading leave types:",e);o.show("Error loading leave type data");t.setProperty("/dataLoaded",true);t.setProperty("/busy",false);this._refreshTableBindings()}})},_refreshTableBindings:function(){try{const e=this.byId("tblRequests");const t=e?.getBinding("items");if(t?.refresh){t.refresh(true)}}catch(e){console.warn("Could not refresh bindings:",e.message)}},formatLeaveTypeDesc:function(e){if(!e)return"";try{const t=this.getView()?.getModel("view");if(!t)return String(e);const o=t.getProperty("/dataLoaded");if(!o)return String(e);const s=t.getProperty("/leaveTypeDescByCode")||{};const n=String(e).trim().toUpperCase();return s[n]||e}catch(t){console.error("Error in formatLeaveTypeDesc:",t);return String(e)}},formatLeaveTypeFullDesc:function(e){if(!e)return"";try{const t=this.getView()?.getModel("view");if(!t)return String(e);const o=t.getProperty("/dataLoaded");if(!o)return String(e);const s=t.getProperty("/leaveTypeFullDescByCode")||{};const n=String(e).trim().toUpperCase();return s[n]||e}catch(t){console.error("Error in formatLeaveTypeFullDesc:",t);return String(e)}},formatDateRange:function(e,t){if(!e&&!t)return"";try{const o=n.getDateInstance({style:"medium"});const s=e?o.format(new Date(e)):"";const r=t?o.format(new Date(t)):"";return s&&r?`${s} → ${r}`:s||r}catch(o){console.error("Error in formatDateRange:",o);return`${e||""} → ${t||""}`}},formatDateTime:function(e){if(!e)return"";try{const t=n.getDateTimeInstance({style:"medium"});return t.format(new Date(e))}catch(t){console.error("Error in formatDateTime:",t);return e}},formatStatusState:function(e){switch((e||"").toLowerCase()){case"pending":return"Warning";case"approved":return"Success";case"rejected":return"Error";case"cancelled":return"None";default:return"None"}},onUpdateFinished:function(e){const t=this.byId("tblRequests");const o=t?.getBinding("items");let s=e.getParameter("total");if((s===undefined||s===null)&&o?.getLength){s=o.getLength()}const n=this.getView().getModel("view");n.setProperty("/counts/leaveRequests",s?`(${s})`:"");this.byId("msEmpty")?.setVisible(!s||s===0);this._updateKPIs()},_updateKPIs:function(){const e=this.byId("tblRequests");const t=e?.getItems()||[];const o=this.getView().getModel("view");let s=0;let n=0;let r=0;const i=new Date;i.setHours(0,0,0,0);t.forEach(e=>{const t=e.getBindingContext();const o=t?.getObject();if(!o)return;const a=(o.status||"").toLowerCase();if(a==="pending"){s++}else if(a==="approved"&&o.approvedAt){const e=new Date(o.approvedAt);e.setHours(0,0,0,0);if(e.getTime()===i.getTime()){n++}}else if(a==="rejected"&&o.approvedAt){const e=new Date(o.approvedAt);e.setHours(0,0,0,0);if(e.getTime()===i.getTime()){r++}}});o.setProperty("/kpi/pending",s);o.setProperty("/kpi/approvedToday",n);o.setProperty("/kpi/rejectedToday",r)},onSelectionChange:function(){const e=this.byId("tblRequests");const t=(e?.getSelectedItems()?.length||0)>0;this.byId("btnApproveSel")?.setEnabled(t);this.byId("btnRejectSel")?.setEnabled(t)},onRowPress:function(e){const t=e.getSource().getBindingContext();const o=this.byId("popDetails");if(o&&t){o.setBindingContext(t);o.openBy(e.getSource())}},onStatusChange:function(){this._applyFilters()},onDateRangeChange:function(){this._applyFilters()},onLiveSearch:function(){this._applyFilters()},onSearch:function(){const e=(this.byId("reqSearch")?.getValue()||"").trim();const t=/^[A-Za-z]{2,}\d{2,}$|^\d{3,}$/.test(e);if(t){this.loadRequestsForEmployee(e)}else if(!e){this.loadRequestsForEmployee("")}else{this._applyFilters()}},onClearFilters:function(){this.byId("selStatus")?.setSelectedKey("All");const e=this.byId("drSubmitted");if(e){e.setDateValue(null);e.setSecondDateValue(null)}this.byId("reqSearch")?.setValue("");this.loadRequestsForEmployee("");this._applyFilters()},onRefresh:function(){const e=this.byId("tblRequests");const t=e?.getBinding("items");const s=this.getView().getModel("view");const n=!!s.getProperty("/useActionFeed");if(n){const e=s.getProperty("/lastActionEmployeeID");if(e){this.loadRequestsForEmployee(e);return}}if(t?.refresh){t.refresh()}o.show("Data refreshed")},_applyFilters:function(){const e=this.byId("tblRequests")?.getBinding("items");if(!e)return;const t=this.getView().getModel("view");const o=!!t.getProperty("/useActionFeed");const s=[];const n=this.byId("selStatus")?.getSelectedKey();if(n&&n!=="All"){s.push(new r("status",i.EQ,n))}const a=this.byId("drSubmitted");if(a?.getDateValue()&&a?.getSecondDateValue()){const e=a.getDateValue();const t=a.getSecondDateValue();s.push(new r({filters:[new r("submittedAt",i.GE,e),new r("submittedAt",i.LE,t)],and:true}))}const c=this.byId("reqSearch")?.getValue();if(c&&c.trim()){if(o){s.push(new r({filters:[new r("empname",i.Contains,c),new r("leaveType",i.Contains,c),new r("reason",i.Contains,c)],and:false}))}else{s.push(new r({filters:[new r("empname",i.Contains,c),new r("employee_employeeId",i.Contains,c),new r("leaveType_code",i.Contains,c),new r("reason",i.Contains,c)],and:false}))}}e.filter(s)},_bindTableToAction:function(e){const o=this.byId("tblRequests");if(!o)return;const s=new t({requests:e||[]});this.getView().setModel(s,"action");const n=o.getBindingInfo("items");const r=n?.template?.clone();o.unbindItems();o.bindItems({path:"action>/requests",template:r});const i=this.getView().getModel("view");i.setProperty("/useActionFeed",true);this._applyFilters()},_bindTableToOData:function(){const e=this.byId("tblRequests");if(!e)return;const t=e.getBindingInfo("items");const o=t?.template?.clone();e.unbindItems();e.bindItems({path:"/LeaveRequests",template:o,parameters:{$count:true}});const s=this.getView().getModel("view");s.setProperty("/useActionFeed",false)},loadRequestsForEmployee:function(e){const t=this.getView().getModel();const n=this.getView().getModel("view");if(!e){this._bindTableToOData();n.setProperty("/lastActionEmployeeID","");this._refreshTableBindings();return}if(!t?.callFunction){s.error("OData action call not available on model.");return}sap.ui.core.BusyIndicator.show(0);t.callFunction("/leaveRequests",{method:"POST",urlParameters:{employeeID:e},success:t=>{sap.ui.core.BusyIndicator.hide();const s=t||{};const r=s.requests||[];const i=Number(s.count||r.length||0);this._bindTableToAction(r);n.setProperty("/lastActionEmployeeID",e);o.show(`Loaded ${i} request(s) for employee ${e}`)},error:e=>{sap.ui.core.BusyIndicator.hide();console.error("leaveRequests action failed:",e);let t="Failed to load employee requests.";try{const o=JSON.parse(e.responseText);t=o?.error?.message||t}catch(e){}s.error(t)}})},onApproveOne:function(e){const t=e.getSource().getBindingContext();const o=t?.getObject();if(!o)return;const n=o.empname||o.employee_employeeId||"Unknown";s.confirm(`Approve leave request for ${n}?`,{onClose:e=>{if(e===s.Action.OK){this._approveRequest(o.ID||o.id)}}})},onRejectOne:function(e){const t=e.getSource().getBindingContext();const o=t?.getObject();if(!o)return;this._openRejectDialog(o)},onApproveFromPopover:function(){const e=this.byId("popDetails");const t=e?.getBindingContext();const o=t?.getObject();if(!o)return;const n=o.empname||o.employee_employeeId||"Unknown";s.confirm(`Approve leave request for ${n}?`,{onClose:t=>{if(t===s.Action.OK){this._approveRequest(o.ID||o.id);e.close()}}})},onRejectFromPopover:function(){const e=this.byId("popDetails");const t=e?.getBindingContext();const o=t?.getObject();if(!o)return;e.close();this._openRejectDialog(o)},onApproveSelected:function(){const e=this.byId("tblRequests");const t=e?.getSelectedItems()||[];if(t.length===0){o.show("Please select at least one request");return}const n=t.map(e=>{const t=e.getBindingContext();const o=t.getObject();return{id:o.ID||o.id}});s.confirm(`Approve ${n.length} leave request(s)?`,{onClose:e=>{if(e===s.Action.OK){this._approveMultipleRequests(n)}}})},onRejectSelected:function(){const e=this.byId("tblRequests");const t=e?.getSelectedItems()||[];if(t.length===0){o.show("Please select at least one request");return}const s=t.map(e=>{const t=e.getBindingContext();const o=t.getObject();const s=o.ID||o.id;const n=o.empname||o.employee_employeeId||"Unknown";const r=o.leaveType||this.formatLeaveTypeFullDesc(o.leaveType_code);return{id:s,empname:n,leaveType:r}});this._openBulkRejectDialog(s)},_openRejectDialog:function(e){const t=this.getView().getModel("view");const o=e.empname||e.employee_employeeId||"Unknown";const s=e.leaveType||this.formatLeaveTypeFullDesc(e.leaveType_code);t.setProperty("/rejectData/employeeName",o);t.setProperty("/rejectData/leaveType",s);t.setProperty("/rejectData/comments","");t.setProperty("/rejectData/commentLength",0);t.setProperty("/rejectData/requestId",e.ID||e.id);t.setProperty("/rejectData/isBulk",false);this.byId("rejectCommentDialog")?.open()},_openBulkRejectDialog:function(e){const t=this.getView().getModel("view");t.setProperty("/rejectData/employeeName",`${e.length} employees`);t.setProperty("/rejectData/leaveType","Multiple requests");t.setProperty("/rejectData/comments","");t.setProperty("/rejectData/commentLength",0);t.setProperty("/rejectData/bulkRequests",e);t.setProperty("/rejectData/isBulk",true);this.byId("rejectCommentDialog")?.open()},onCommentChange:function(e){const t=e.getParameter("value")||"";this.getView().getModel("view").setProperty("/rejectData/commentLength",t.length)},onConfirmReject:function(){const e=this.getView().getModel("view");const t=e.getProperty("/rejectData");if(!t.comments||!t.comments.trim()){o.show("Please enter rejection comments");return}if(t.isBulk){this._rejectMultipleRequests(t.bulkRequests,t.comments)}else{this._rejectRequest(t.requestId,t.comments)}this.byId("rejectCommentDialog")?.close()},onCancelReject:function(){this.byId("rejectCommentDialog")?.close()},_approveRequest:function(e){const t=this.getView().getModel();const n="MANAGER001";const r={requestId:e,approverId:n,comments:""};if(t?.callFunction){sap.ui.core.BusyIndicator.show(0);t.callFunction("/approveLeaveRequest",{method:"POST",urlParameters:r,success:()=>{sap.ui.core.BusyIndicator.hide();o.show("Leave request approved successfully");this.onRefresh()},error:e=>{sap.ui.core.BusyIndicator.hide();console.error("Approve error:",e);let t="Failed to approve leave request.";try{const o=JSON.parse(e.responseText);t=o?.error?.message||t}catch(e){}s.error(t)}})}else{s.information("OData action call not available")}},_rejectRequest:function(e,t){const n=this.getView().getModel();const r="MANAGER001";const i={requestId:e,approverId:r,comments:t};if(n?.callFunction){sap.ui.core.BusyIndicator.show(0);n.callFunction("/rejectLeaveRequest",{method:"POST",urlParameters:i,success:()=>{sap.ui.core.BusyIndicator.hide();o.show("Leave request rejected successfully");this.onRefresh()},error:e=>{sap.ui.core.BusyIndicator.hide();console.error("Reject error:",e);let t="Failed to reject leave request.";try{const o=JSON.parse(e.responseText);t=o?.error?.message||t}catch(e){}s.error(t)}})}else{s.information("OData action call not available")}},_approveMultipleRequests:function(e){const t=this.getView().getModel();const n="MANAGER001";let r=0;let i=0;sap.ui.core.BusyIndicator.show(0);const a=c=>{if(c>=e.length){sap.ui.core.BusyIndicator.hide();if(i===0){o.show(`Successfully approved ${r} request(s)`)}else{s.warning(`Approved ${r} request(s).\n${i} request(s) failed.`)}this.onRefresh();return}const l=e[c];const u={requestId:l.id,approverId:n,comments:""};if(t?.callFunction){t.callFunction("/approveLeaveRequest",{method:"POST",urlParameters:u,success:()=>{r++;a(c+1)},error:e=>{i++;console.error(`Failed to approve request ${l.id}:`,e);a(c+1)}})}else{sap.ui.core.BusyIndicator.hide();s.information("OData action call not available")}};a(0)},_rejectMultipleRequests:function(e,t){const n=this.getView().getModel();const r="MANAGER001";let i=0;let a=0;sap.ui.core.BusyIndicator.show(0);const c=l=>{if(l>=e.length){sap.ui.core.BusyIndicator.hide();if(a===0){o.show(`Successfully rejected ${i} request(s)`)}else{s.warning(`Rejected ${i} request(s).\n${a} request(s) failed.`)}this.onRefresh();return}const u=e[l];const d={requestId:u.id,approverId:r,comments:t};if(n?.callFunction){n.callFunction("/rejectLeaveRequest",{method:"POST",urlParameters:d,success:()=>{i++;c(l+1)},error:e=>{a++;console.error(`Failed to reject request ${u.id}:`,e);c(l+1)}})}else{sap.ui.core.BusyIndicator.hide();s.information("OData action call not available")}};c(0)},onLogout:function(){s.confirm("Are you sure you want to logout?",{actions:[s.Action.OK,s.Action.CANCEL],emphasizedAction:s.Action.OK,onClose:e=>{if(e!==s.Action.OK)return;try{sessionStorage.clear()}catch(e){console.error("Error clearing session storage:",e)}try{localStorage.clear()}catch(e){console.error("Error clearing local storage:",e)}if(sap.ushell?.Container){window.location.hash="#Shell-home";return}const t=this.getOwnerComponent?.();const o=t?.getRouter?.();if(o?.navTo){o.navTo("Login",{},true);return}window.location.replace("/login")}})}})});
//# sourceMappingURL=Manager.controller.js.map