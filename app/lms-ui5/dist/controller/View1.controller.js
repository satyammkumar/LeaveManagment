sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,s){"use strict";return e.extend("lmsui5.controller.View1",{onRegister:function(){this.getOwnerComponent().getRouter().navTo("Register")},onInit:function(){const e=this.byId("username");const t=this.byId("password");if(e){e.addEventDelegate({onsapenter:function(){t&&t.focus()}})}if(t){t.addEventDelegate({onsapenter:function(){this.onLogin()}.bind(this)})}const s=this.getOwnerComponent().getRouter();s.getRoute("Login").attachPatternMatched(this._onLoginRouteMatched,this);this.getView().addEventDelegate({onBeforeShow:function(){this._resetLoginForm()}.bind(this)})},_resetLoginForm:function(){const e=this.byId("username");const t=this.byId("password");const s=this.byId("msg");if(e)e.setValue("");if(t)t.setValue("");if(s)s.setVisible(false)},_onLoginRouteMatched:function(){this._resetLoginForm();const e=this.getOwnerComponent().getModel("auth");if(e){e.setProperty("/isAuthenticated",false);e.setProperty("/error","");e.setProperty("/user",{})}},onLogin:async function(){const e=(this.byId("username").getValue()||"").trim();const t=(this.byId("password").getValue()||"").trim();if(!e||!t){this._showError("Please enter email and password.");return}const o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!o.test(e)){this._showError("Please enter a valid email address.");return}const n=this.byId("msg");if(n)n.setVisible(false);try{const o=await fetch("/odata/v4/my-services/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!o.ok){const e=o.clone();let t="Invalid credentials";try{const e=await o.json();t=e?.error?.message||e?.message||t}catch(s){try{t=await e.text()||t}catch(e){}}throw new Error(t)}const n=await o.json();const r=n?.employee;const i=this.getOwnerComponent().getRouter();const a=this.getOwnerComponent().getModel("auth");if(a){a.setData({user:n,isAuthenticated:true,error:""})}try{localStorage.setItem("login_email",e)}catch(e){}if(!r){s.show("Invalid user");return}s.show(`Welcome, ${r?.firstName||r?.email}`);const c=(r?.email||"").toLowerCase()==="admin@gmail.com";const l=(n?.role||n?.employee?.role||"").toLowerCase();const g=l==="manager";if(c||g){i.navTo("Manager")}else{const e=r?.email;if(e){i.navTo("Employee",{username:e})}else{i.navTo("Employee")}}}catch(e){this._showError(e.message||"Login failed")}},_showError:function(e){const s=this.getOwnerComponent().getModel("auth");if(s){s.setProperty("/error",e);s.setProperty("/isAuthenticated",false)}const o=this.byId("msg");if(o){o.setText(e);o.setType("Error");o.setShowIcon(true);o.setVisible(true)}t.error(e)},onAfterRendering:function(){try{const e=localStorage.getItem("login_email");if(e)this.byId("username").setValue(e)}catch(e){}},onOpenRegister:function(){this.getOwnerComponent().getRouter().navTo("Register")},onCancelRegister:function(){const e=this.byId("registerDialog");e&&e.close()},onSubmitRegister:async function(){const e=this.getOwnerComponent().getModel("auth");const o=e.getProperty("/register")||{};const{firstName:n,lastName:r,email:i,password:a,confirm:c}=o;if(!n||!r||!i||!a||!c){t.warning("Please fill in all required fields.");return}if(a!==c){t.error("Passwords do not match.");return}const l=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!l.test(i)){t.error("Please enter a valid email address.");return}try{s.show("Registration successful! Please log in.");this.onCancelRegister()}catch(e){console.error("Registration error:",e);t.error(e.message||"Failed to register.")}}})});
//# sourceMappingURL=View1.controller.js.map