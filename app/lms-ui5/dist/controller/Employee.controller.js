sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/format/DateFormat"],function(e,t,s,n,a,o,r,i){"use strict";return e.extend("lmsui5.controller.Employee",{onInit:function(){if(!this.getOwnerComponent().getModel("user")){this.getOwnerComponent().setModel(new n({}),"user")}this.getView().setModel(new n(this._buildApplyLeaveModelData()),"applyLeave");this.getView().setModel(new n({requests:[],counts:{total:0,pending:0,approved:0,rejected:0}}),"leaveRequests");const e=this.getOwnerComponent().getRouter();e.getRoute("Employee").attachPatternMatched(this._onRouteMatched,this);this.getView().addEventDelegate({onAfterShow:function(){this._applyEmployeeFilter();this._refreshOwnLeaveData()}.bind(this)});this._bus=sap.ui.getCore().getEventBus();this._bus.subscribe("leave","changed",this._onLeaveChanged,this)},onExit:function(){if(this._pApplyLeaveDlg){this._pApplyLeaveDlg.then(function(e){e.destroy()});this._pApplyLeaveDlg=null}if(this._pRequestDetailsDlg){this._pRequestDetailsDlg.then(function(e){e.destroy()});this._pRequestDetailsDlg=null}if(this._pManagerMsgDlg){this._pManagerMsgDlg.then(function(e){e.destroy()});this._pManagerMsgDlg=null}if(this._bus){this._bus.unsubscribe("leave","changed",this._onLeaveChanged,this)}},getEmployeeData:async function(e){const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!t.test(e)){this._showError("Please enter a valid email address.");return}const s=this.byId("msg");if(s)s.setVisible(false);try{const t=await fetch("/odata/v4/my-services/getEmployeeData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok){const e=t.clone();let s="Failed to fetch employee data";try{s=(await t.json())?.error?.message||s}catch{try{s=await e.text()}catch{}}throw new Error(s)}const s=await t.json();const n=this.getOwnerComponent().getModel("user");if(n&&s.employee){n.setProperty("/id",s.employee.id);n.setProperty("/employeeId",s.employee.employeeID);n.setProperty("/firstName",s.employee.firstName);n.setProperty("/lastName",s.employee.lastName);n.setProperty("/email",s.employee.email);n.setProperty("/department",s.employee.department);n.setProperty("/managerId",s.employee.managerID);const e=`${s.employee.firstName||""} ${s.employee.lastName||""}`.trim();n.setProperty("/fullName",e);if(Array.isArray(s.leaveBalances)){n.setProperty("/leaveBalances",s.leaveBalances)}}a.show("Employee data loaded successfully");this._applyEmployeeFilter();this._loadMyLeaveRequests()}catch(e){this._showError(e.message||"Failed to load employee data");console.error("API Error:",e)}},_showError:function(e){a.show(e,{duration:3e3})},_onRouteMatched:function(e){const t=e.getParameter("arguments");const s=t.username;const n=this.getOwnerComponent().getModel("auth");if(n&&s){n.setProperty("/username",s)}if(s){this.getEmployeeData(s)}},_applyEmployeeFilter:function(){const e=this.getOwnerComponent().getModel("user");const n=e&&e.getProperty("/employeeId");const a=this.byId("balancesTable")?.getBinding("items");if(!a)return;if(n){a.filter([new t("employee/employeeId",s.EQ,n)])}else{a.filter([])}},onSearch:function(e){const t=e.getParameter("query");this._applySearchFilter(t)},onLiveChange:function(e){const t=e.getParameter("newValue");this._applySearchFilter(t)},_applySearchFilter:function(e){const n=this.byId("balancesTable")?.getBinding("items");if(!n)return;const a=[];const o=this.getOwnerComponent().getModel("user");const r=o&&o.getProperty("/employeeId");if(r){a.push(new t("employee/employeeId",s.EQ,r))}if(e){a.push(new t({filters:[new t("leaveType/code",s.Contains,e),new t("leaveType/description",s.Contains,e)],and:false}))}n.filter(a)},onClear:function(){const e=this.byId("sf");e&&e.setValue("");this._applySearchFilter("")},onRefresh:function(){const e=this.byId("balancesTable")?.getBinding("items");if(e){e.refresh();a.show("Data refreshed")}this._loadMyLeaveRequests()},onLogout:function(){var e=this;sap.m.MessageBox.confirm("Are you sure you want to logout?",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,onClose:function(t){if(t!==sap.m.MessageBox.Action.OK){return}try{sessionStorage.clear()}catch(e){}try{localStorage.clear()}catch(e){}if(sap.ushell&&sap.ushell.Container){try{window.location.hash="#Shell-home";return}catch(e){}}var s=e.getOwnerComponent&&e.getOwnerComponent();var n=s&&s.getRouter&&s.getRouter();if(n&&n.navTo){n.navTo("Login",{},true);return}window.location.replace("/login")}})},formatBalanceState:function(e){const t=Number(e);if(isNaN(t))return"None";if(t<0)return"Error";if(t===0)return"Warning";return"Success"},formatStatusState:function(e){switch((e||"").toLowerCase()){case"pending":return"Warning";case"approved":return"Success";case"rejected":return"Error";case"cancelled":return"None";default:return"None"}},formatDateRange:function(e,t){if(!e&&!t)return"";try{const s=i.getDateInstance({style:"medium"});const n=e?s.format(new Date(e)):"";const a=t?s.format(new Date(t)):"";return n&&a?`${n} → ${a}`:n||a}catch(s){return`${e||""} → ${t||""}`}},formatDateTime:function(e){if(!e)return"";try{const t=i.getDateTimeInstance({style:"medium"});return t.format(new Date(e))}catch(t){return e}},_loadMyLeaveRequests:async function(){const e=this.getOwnerComponent().getModel("user");const t=e?.getProperty("/employeeId");if(!t)return;try{const e=await fetch("/odata/v4/my-services/leaveRequests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employeeID:t})});if(!e.ok)throw new Error("Failed to load leave requests");const s=await e.json();const n=s.requests||[];const a={total:n.length,pending:n.filter(e=>e.status==="Pending").length,approved:n.filter(e=>e.status==="Approved").length,rejected:n.filter(e=>e.status==="Rejected").length};const o=this.getView().getModel("leaveRequests");o.setProperty("/requests",n);o.setProperty("/counts",a);this._checkForRejectionNotifications(n)}catch(e){console.error("Failed to load leave requests:",e)}},_checkForRejectionNotifications:function(e){const t=e.filter(e=>e.status==="Rejected"&&e.managerComments);if(t.length>0){const e=t[0];o.warning(e.managerComments||"No reason provided by manager",{title:"Leave Request Rejected",details:`Leave Type: ${e.leaveType}\nPeriod: ${this.formatDateRange(e.startDate,e.endDate)}\nDays: ${e.daysRequested}`,actions:[o.Action.OK,"View All Requests"],emphasizedAction:o.Action.OK,onClose:e=>{if(e==="View All Requests"){const e=this.byId("myRequestsTable");if(e){e.getDomRef()?.scrollIntoView({behavior:"smooth"})}}}})}},onViewRequestDetails:function(e){const t=e.getSource().getBindingContext("leaveRequests");const s=t&&t.getObject();if(!s)return;const n=this.getView().getId()+"--requestDetailsFrag";if(!this._pRequestDetailsDlg){this._pRequestDetailsDlg=r.load({name:"lmsui5.view.RequestDetail",controller:this,id:n}).then(function(e){this.getView().addDependent(e);return e}.bind(this)).catch(function(e){console.error("RequestDetail fragment load failed:",e);o.error(e.message||"Failed to open the details dialog.")})}this._pRequestDetailsDlg.then(function(e){e.setBindingContext(t,"leaveRequests");e.open()})},onCloseRequestDetails:function(){if(this._pRequestDetailsDlg){this._pRequestDetailsDlg.then(function(e){e.close()})}},onOpenApplyLeave:function(){const e=this.getView().getModel("applyLeave");e.setData(this._buildApplyLeaveModelData());const t=this.getView().getId()+"--applyLeaveFrag";if(!this._pApplyLeaveDlg){this._pApplyLeaveDlg=r.load({name:"lmsui5.view.ApplyLeave",controller:this,id:t}).then(function(e){this.getView().addDependent(e);return e}.bind(this)).catch(function(e){console.error("ApplyLeave fragment load failed:",e);o.error("Failed to load Apply Leave dialog.")})}this._pApplyLeaveDlg.then(function(e){const s=r.byId(t,"leaveCalendar");if(s){if(s.setSingleSelection)s.setSingleSelection(true);if(s.setIntervalSelection)s.setIntervalSelection(true);s.removeAllSelectedDates()}e.open()})},onCancelApplyLeave:function(){const e=this.getView().getId()+"--applyLeaveFrag";if(this._pApplyLeaveDlg){this._pApplyLeaveDlg.then(function(t){const s=r.byId(e,"leaveCalendar");if(s)s.removeAllSelectedDates();t.close()})}this.getView().getModel("applyLeave").setData(this._buildApplyLeaveModelData())},onCalendarSelect:function(e){const t=e.getSource();const s=t.getSelectedDates()||[];const n=s[0];const a=this.getView().getModel("applyLeave");if(n){const e=n.getStartDate();const t=n.getEndDate()||e;const s=this._toISODate(e);const o=this._toISODate(t);const r=this._expandBusinessDates(e,t);const i=r.length;a.setProperty("/startDate",e);a.setProperty("/endDate",t);a.setProperty("/startDateISO",s);a.setProperty("/endDateISO",o);a.setProperty("/totalDays",i);a.setProperty("/selectedDates",r);a.setProperty("/rangeText",i?`Selected: ${s} → ${o} (${i} business day${i>1?"s":""})`:`Selected: ${s} → ${o} (0 business days — weekends excluded)`)}else{a.setProperty("/startDate",null);a.setProperty("/endDate",null);a.setProperty("/startDateISO","");a.setProperty("/endDateISO","");a.setProperty("/totalDays",0);a.setProperty("/selectedDates",[]);a.setProperty("/rangeText","")}},onSubmitLeave:async function(){const e=this.getView().getModel("applyLeave");const t=this.getOwnerComponent().getModel("user")?.getProperty("/employeeId");const s=e.getProperty("/selectedLeaveType");const n=e.getProperty("/startDateISO");const r=e.getProperty("/endDateISO");const i=(e.getProperty("/reason")||"").trim();if(!s){return o.warning("Please select a leave type.")}if(!n||!r){return o.warning("Please select a valid date range.")}try{const e=this.getView().getModel();const o=e.bindContext("/submitLeaveRequest(...)");o.setParameter("employeeId",t);o.setParameter("leaveTypeCode",s);o.setParameter("startDate",n);o.setParameter("endDate",r);o.setParameter("reason",i);await o.execute();a.show("Leave application submitted.");this.onCancelApplyLeave();await this._refreshOwnLeaveData();sap.ui.getCore().getEventBus().publish("leave","changed",{employeeId:t,source:"employee",change:"submitted"})}catch(e){console.error("Submit leave error:",e);o.error(e.message||"Failed to submit leave request")}},_buildApplyLeaveModelData:function(){return{selectedLeaveType:"",leaveTypes:this._getAvailableLeaveTypes(),minDate:this._getTodayStart(),maxDate:this._getYearEnd(),startDate:null,endDate:null,startDateISO:"",endDateISO:"",totalDays:0,selectedDates:[],rangeText:"",reason:""}},_getAvailableLeaveTypes:function(){const e=this.getOwnerComponent().getModel("user");const t=new Map;const s=e?.getProperty("/leaveTypes");if(Array.isArray(s)&&s.length){s.forEach(function(e){const s=e.code||e.leaveTypeCode||"";const n=e.description||e.code||"";if(s&&!t.has(s))t.set(s,{code:s,description:n})})}const n=e?.getProperty("/leaveBalances")||[];n.forEach(function(e){const s=e.leaveTypeCode;const n=e.leaveTypeDescription||e.description||s;if(s&&!t.has(s))t.set(s,{code:s,description:n})});if(t.size===0){return[{code:"CL",description:"Casual Leave"},{code:"SL",description:"Sick Leave"},{code:"EL",description:"Earned Leave"}]}return Array.from(t.values())},_getTodayStart:function(){const e=new Date;e.setHours(0,0,0,0);return e},_getYearEnd:function(){const e=new Date;e.setMonth(11,31);e.setHours(23,59,59,999);return e},_toISODate:function(e){const t=e.getFullYear();const s=String(e.getMonth()+1).padStart(2,"0");const n=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${n}`},_isWeekend:function(e){const t=e.getDay();return t===0||t===6},_expandBusinessDates:function(e,t){const s=[];const n=new Date(e.getFullYear(),e.getMonth(),e.getDate());const a=new Date(t.getFullYear(),t.getMonth(),t.getDate());while(n<=a){if(!this._isWeekend(n)){s.push(this._toISODate(n))}n.setDate(n.getDate()+1)}return s},_refreshOwnLeaveData:async function(){const e=this.byId("balancesTable")?.getBinding("items");e?.refresh();await this._loadMyLeaveRequests();try{const e=this.getOwnerComponent().getModel("auth")?.getProperty("/username");if(e){const t=await fetch("/odata/v4/my-services/getEmployeeData",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(t.ok){const e=await t.json();const s=this.getOwnerComponent().getModel("user");if(s&&e.employee){s.setProperty("/leaveBalances",e.leaveBalances||[])}}}}catch(e){}},_onLeaveChanged:function(e,t,s){try{const e=this.getOwnerComponent().getModel("user")?.getProperty("/employeeId");if(!e)return;if(s&&s.employeeId&&s.employeeId!==e)return;this._refreshOwnLeaveData()}catch(e){}},__mmFallback:function(e){if(e&&String(e).trim())return e;return"No message from manager yet."},onOpenManagerMessage:function(e){const t=e.getSource().getBindingContext("leaveRequests")||e.getSource().getBindingContext();if(!t){return sap.m.MessageToast.show("No request selected.")}const s=this.getView().getId()+"--managerMessageFrag";if(!this._pManagerMsgDlg){this._pManagerMsgDlg=r.load({name:"lmsui5.view.ManagerMessageDialog",controller:this,id:s}).then(function(e){this.getView().addDependent(e);return e}.bind(this)).catch(function(e){console.error("ManagerMessageDialog load failed:",e);o.error(e.message||"Failed to open the message dialog.")})}this._pManagerMsgDlg.then(function(e){e.setBindingContext(t,"leaveRequests");e.open()})},onCloseManagerMessage:function(){if(this._pManagerMsgDlg){this._pManagerMsgDlg.then(function(e){e.close()})}},onManagerMessageLiveChange:function(){},onCopyManagerMessage:function(){const e=this.getView().getId()+"--managerMessageFrag";const t=r.byId(e,"mmText");const s=t?.getValue()||"";if(!navigator.clipboard){try{const e=document.createElement("textarea");e.value=s;e.style.position="fixed";e.style.left="-9999px";document.body.appendChild(e);e.select();document.execCommand("copy");document.body.removeChild(e);a.show("Message copied")}catch(e){o.information("Copy not available on this browser.")}return}navigator.clipboard.writeText(s).then(()=>a.show("Message copied"),()=>o.information("Copy not available on this browser."))}})});
//# sourceMappingURL=Employee.controller.js.map